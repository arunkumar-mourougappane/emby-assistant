<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emby Assistant</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            padding: 20px 0;
        }

        .header-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .status-online {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .status-offline {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        .info-badge {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            display: inline-block;
            margin: 5px;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .card-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: 15px 15px 0 0 !important;
            border: none;
            padding: 15px 20px;
        }

        .media-item, .task-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            gap: 15px;
        }

        .media-item:hover, .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .media-item .thumbnail {
            flex-shrink: 0;
            width: 100px;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 2em;
        }

        .media-item .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .media-item .thumbnail.person {
            width: 150px;
            height: 150px;
            border-radius: 50%;
        }

        .media-item .thumbnail.person img {
            border-radius: 50%;
            object-fit: cover;
        }

        .media-item .content {
            flex: 1;
            min-width: 0;
        }

        .task-item {
            display: block;
        }

        .progress {
            height: 25px;
            border-radius: 10px;
            background-color: #e5e7eb;
        }

        .progress-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            border-radius: 10px;
            font-weight: 600;
        }

        .badge-custom {
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 12px;
            font-weight: 600;
        }

        .badge-running {
            background-color: #10b981;
        }

        .badge-completed {
            background-color: #3b82f6;
        }

        .badge-movie {
            background-color: #f59e0b;
        }

        .badge-episode {
            background-color: #8b5cf6;
        }

        .badge-series {
            background-color: #ec4899;
        }

        .badge-person {
            background-color: #06b6d4;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state .emoji {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .btn-refresh {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            color: white;
            transition: transform 0.2s;
        }

        .btn-refresh:hover {
            transform: scale(1.05);
            color: white;
        }

        .item-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 1.05rem;
        }

        .item-meta {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .nav-tabs .nav-link {
            color: #666;
            border: none;
            border-bottom: 3px solid transparent;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: none;
        }

        .nav-tabs {
            border-bottom: 2px solid #e5e7eb;
        }

        /* Movies carousel styles */
        .movies-carousel {
            display: flex;
            overflow-x: auto;
            gap: 20px;
            padding: 15px 5px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .movies-carousel::-webkit-scrollbar {
            height: 8px;
        }

        .movies-carousel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .movies-carousel::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        .movie-card {
            flex: 0 0 200px;
            cursor: pointer;
            transition: transform 0.2s;
            border-radius: 10px;
            overflow: hidden;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .movie-card .movie-poster {
            width: 200px;
            height: 300px;
            object-fit: cover;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            color: #9ca3af;
        }

        .movie-card .movie-poster img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .movie-card .movie-info {
            padding: 10px;
        }

        .movie-card .movie-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .movie-card .movie-year {
            font-size: 0.8rem;
            color: #666;
        }

        .cast-carousel {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 10px 0;
            scroll-behavior: smooth;
        }

        .cast-member {
            text-align: center;
            min-width: 100px;
        }

        .cast-member img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
        }

        .cast-member .cast-name {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: 600;
        }

        .cast-member .cast-role {
            font-size: 0.7rem;
            color: #666;
        }

        .btn-emby-link {
            background: linear-gradient(135deg, #52b54b, #00a4dc);
            color: white;
            border: none;
            transition: transform 0.2s;
        }

        .btn-emby-link:hover {
            transform: scale(1.05);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header-card p-4">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <h1 class="mb-0">
                    <span class="status-indicator status-offline" id="statusIndicator"></span>
                    Emby Assistant
                </h1>
                <button class="btn btn-sm btn-outline-primary" id="showServerDetailsBtn"
                        onclick="showServerDetails()" style="display: none;">
                    ‚ÑπÔ∏è Server Details
                </button>
            </div>
            <div id="serverInfo">
                <div class="text-center py-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 mb-0">Loading server information...</p>
                </div>
            </div>
        </header>

        <!-- Main Grid -->
        <div class="row">
            <!-- Current Processing -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            Currently Processing
                            <span class="pulse ms-2" style="font-size: 0.8rem;">‚óè</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="currentProcessing">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-refresh btn-sm me-2" onclick="loadCurrentProcessing()">
                                üîÑ Refresh
                            </button>
                            <small class="text-muted">Auto-refreshes every 5s</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recently Completed -->
            <div class="col-lg-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recently Completed Tasks</h5>
                    </div>
                    <div class="card-body">
                        <div id="completedTasks">
                            <div class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-refresh btn-sm" onclick="loadCompletedTasks()">
                                üîÑ Refresh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movies Browser -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üé¨ Movies Browser</h5>
            </div>
            <div class="card-body">
                <!-- Library Tabs -->
                <ul class="nav nav-tabs mb-3" id="libraryTabs" style="display: none;">
                    <!-- Tabs will be populated dynamically -->
                </ul>

                <div id="moviesContainer">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-refresh btn-sm" onclick="loadMoviesWithLibraries()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Indexed Media -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Recently Indexed Media</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="mediaTabs">
                    <li class="nav-item">
                        <button class="nav-link active" onclick="switchTab('recent', this)">
                            Recent (50)
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" onclick="switchTab('all', this)">
                            All Items (100)
                        </button>
                    </li>
                </ul>
                <div id="indexedMedia">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-refresh btn-sm" onclick="loadIndexedMedia()">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Details Modal -->
    <div class="modal fade" id="serverDetailsModal" tabindex="-1" aria-labelledby="serverDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
                    <h5 class="modal-title" id="serverDetailsModalLabel">Server Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="serverDetailsContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Movie Details Modal -->
    <div class="modal fade" id="movieDetailsModal" tabindex="-1" aria-labelledby="movieDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;">
                    <h5 class="modal-title" id="movieDetailsModalLabel">Movie Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="movieDetailsContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-emby-link" id="embyLinkBtn" style="display: none;">
                        üîó Open in Emby
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/jquery.min.js"></script>
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTab = 'recent';

        function switchTab(tab, element) {
            currentTab = tab;
            $('.nav-link').removeClass('active');
            $(element).addClass('active');
            loadIndexedMedia();
        }

        async function loadServerStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();

                if (data.error) {
                    $('#serverInfo').html(`
                        <div class="alert alert-danger mb-0">${data.error}</div>
                    `);
                    $('#statusIndicator').removeClass('status-online').addClass('status-offline');
                    return;
                }

                $('#statusIndicator').removeClass('status-offline').addClass('status-online');
                $('#serverInfo').html(`
                    <div>
                        <span class="info-badge">üì° ${data.server_name}</span>
                        <span class="info-badge">üî¢ v${data.version}</span>
                        <span class="info-badge">üíª ${data.operating_system}</span>
                    </div>
                `);
                // Show server details button
                $('#showServerDetailsBtn').show();
            } catch (error) {
                $('#serverInfo').html(`
                    <div class="alert alert-danger mb-0">Failed to connect to Emby server</div>
                `);
                $('#statusIndicator').removeClass('status-online').addClass('status-offline');
            }
        }

        async function showServerDetails() {
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('serverDetailsModal'));
            modal.show();

            // Load server details
            try {
                const response = await fetch('/api/server-details');
                const data = await response.json();

                if (data.error) {
                    $('#serverDetailsContent').html(`
                        <div class="alert alert-danger">${data.error}</div>
                    `);
                    return;
                }

                // Format server details in a nice layout
                $('#serverDetailsContent').html(`
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <strong>üñ•Ô∏è System Information</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tr><td class="text-muted">Product:</td><td><strong>${data.product_name}</strong></td></tr>
                                        <tr><td class="text-muted">Version:</td><td>${data.version}</td></tr>
                                        <tr><td class="text-muted">OS:</td><td>${data.operating_system}</td></tr>
                                        <tr><td class="text-muted">Architecture:</td><td>${data.system_architecture}</td></tr>
                                        <tr><td class="text-muted">Runtime:</td><td>${data.runtime_version}</td></tr>
                                        <tr><td class="text-muted">Package:</td><td>${data.package_name}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <strong>üåê Network</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tr><td class="text-muted">Server ID:</td><td><small>${data.id}</small></td></tr>
                                        <tr><td class="text-muted">Local Address:</td><td>${data.local_address}</td></tr>
                                        <tr><td class="text-muted">WAN Address:</td><td>${data.wan_address}</td></tr>
                                        <tr><td class="text-muted">HTTP Port:</td><td>${data.http_server_port_number}</td></tr>
                                        <tr><td class="text-muted">HTTPS Port:</td><td>${data.https_port_number}</td></tr>
                                        <tr><td class="text-muted">WebSocket Port:</td><td>${data.web_socket_port_number}</td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <strong>üìÇ Paths</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tr><td class="text-muted">Program Data:</td><td><small>${data.program_data_path}</small></td></tr>
                                        <tr><td class="text-muted">Cache:</td><td><small>${data.cache_path}</small></td></tr>
                                        <tr><td class="text-muted">Logs:</td><td><small>${data.log_path}</small></td></tr>
                                        <tr><td class="text-muted">Metadata:</td><td><small>${data.internal_metadata_path}</small></td></tr>
                                        <tr><td class="text-muted">Transcoding:</td><td><small>${data.transcoding_temp_path}</small></td></tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <strong>‚öôÔ∏è Capabilities</strong>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-borderless mb-0">
                                        <tr>
                                            <td class="text-muted">Can Self Restart:</td>
                                            <td>${data.can_self_restart ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Can Self Update:</td>
                                            <td>${data.can_self_update ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Is Local:</td>
                                            <td>${data.is_local ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Is In Network:</td>
                                            <td>${data.is_in_network ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Pending Restart:</td>
                                            <td>${data.has_pending_restart ? '<span class="badge bg-warning">Yes</span>' : '<span class="badge bg-success">No</span>'}</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Is Shutting Down:</td>
                                            <td>${data.is_shutting_down ? '<span class="badge bg-danger">Yes</span>' : '<span class="badge bg-success">No</span>'}</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            } catch (error) {
                $('#serverDetailsContent').html(`
                    <div class="alert alert-danger">Failed to load server details</div>
                `);
            }
        }

        async function loadCurrentProcessing() {
            try {
                const response = await fetch('/api/current-processing');
                const data = await response.json();

                const container = $('#currentProcessing');

                if (data.length === 0) {
                    container.html(`
                        <div class="empty-state">
                            <div class="emoji">‚ú®</div>
                            <div>No active processing tasks</div>
                        </div>
                    `);
                    return;
                }

                container.html(data.map(item => `
                    <div class="task-item">
                        <div class="item-title">
                            <span class="badge badge-custom badge-running">${item.state}</span>
                            ${item.task_name}
                        </div>
                        <div class="item-meta">Category: ${item.category}</div>
                        ${item.description ? `<div class="item-meta">${item.description}</div>` : ''}
                        <div class="item-meta">Started: ${item.started_at}</div>
                        <div class="progress mt-2">
                            <div class="progress-bar" role="progressbar" style="width: ${item.progress}%"
                                 aria-valuenow="${item.progress}" aria-valuemin="0" aria-valuemax="100">
                                ${item.progress.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `).join(''));
            } catch (error) {
                $('#currentProcessing').html(`
                    <div class="alert alert-danger">Failed to load processing tasks</div>
                `);
            }
        }

        async function loadCompletedTasks() {
            try {
                const response = await fetch('/api/completed-tasks');
                const data = await response.json();

                const container = $('#completedTasks');

                if (data.length === 0) {
                    container.html(`
                        <div class="empty-state">
                            <div class="emoji">üìã</div>
                            <div>No completed tasks yet</div>
                        </div>
                    `);
                    return;
                }

                container.html(data.map(task => `
                    <div class="task-item">
                        <div class="item-title">
                            <span class="badge badge-custom badge-completed">${task.status}</span>
                            ${task.name}
                        </div>
                        <div class="item-meta">Category: ${task.category}</div>
                        <div class="item-meta">‚è±Ô∏è Duration: ${task.duration}</div>
                        <div class="item-meta">‚úÖ Completed: ${task.completed_at}</div>
                    </div>
                `).join(''));
            } catch (error) {
                $('#completedTasks').html(`
                    <div class="alert alert-danger">Failed to load completed tasks</div>
                `);
            }
        }

        async function loadIndexedMedia() {
            try {
                const limit = currentTab === 'recent' ? 50 : 100;
                const response = await fetch(`/api/indexed-media?limit=${limit}`);
                const data = await response.json();

                const container = $('#indexedMedia');

                if (data.length === 0) {
                    container.html(`
                        <div class="empty-state">
                            <div class="emoji">üé¨</div>
                            <div>No indexed media found</div>
                        </div>
                    `);
                    return;
                }

                container.html(data.map(item => {
                    let badgeClass = 'badge-movie';
                    let displayName = item.name;

                    if (item.type === 'Episode') {
                        badgeClass = 'badge-episode';
                        if (item.series_name) {
                            displayName = `${item.series_name} - S${item.season || '?'}E${item.episode || '?'} - ${item.name}`;
                        }
                    } else if (item.type === 'Series') {
                        badgeClass = 'badge-series';
                    } else if (item.type === 'Person') {
                        badgeClass = 'badge-person';
                    }

                    // Show thumbnail for movies, videos, and persons
                    let thumbnailHtml = '';
                    if ((item.type === 'Movie' || item.type === 'Video') && item.id) {
                        thumbnailHtml = `
                            <div class="thumbnail">
                                <img src="/api/image/${item.id}" alt="${item.name}"
                                     onerror="this.parentElement.innerHTML='üé¨'">
                            </div>
                        `;
                    } else if (item.type === 'Person' && item.id) {
                        thumbnailHtml = `
                            <div class="thumbnail person">
                                <img src="/api/person-image/${item.id}" alt="${item.name}"
                                     onerror="this.parentElement.innerHTML='üë§'">
                            </div>
                        `;
                    }

                    return `
                        <div class="media-item">
                            ${thumbnailHtml}
                            <div class="content">
                                <div class="item-title">
                                    <span class="badge badge-custom ${badgeClass}">${item.type}</span>
                                    ${displayName}
                                </div>
                                <div class="item-meta">üìÖ Added: ${item.added_at}</div>
                                <div class="item-meta" style="font-size: 0.85rem; color: #999;">
                                    üìÅ ${item.path}
                                </div>
                            </div>
                        </div>
                    `;
                }).join(''));
            } catch (error) {
                $('#indexedMedia').html(`
                    <div class="alert alert-danger">Failed to load indexed media</div>
                `);
            }
        }

        let currentLibraryId = null;
        let movieLibraries = [];

        async function loadMoviesWithLibraries() {
            try {
                // Load libraries first
                const librariesResponse = await fetch('/api/libraries');
                movieLibraries = await librariesResponse.json();

                const tabsContainer = $('#libraryTabs');

                if (movieLibraries.length > 0) {
                    // Show tabs and create tab items
                    tabsContainer.show();
                    tabsContainer.html(`
                        <li class="nav-item">
                            <a class="nav-link active" href="#" onclick="switchLibrary(null); return false;">
                                All Movies
                            </a>
                        </li>
                        ${movieLibraries.map(lib => `
                            <li class="nav-item">
                                <a class="nav-link" href="#" onclick="switchLibrary('${lib.id}'); return false;">
                                    ${lib.name}
                                </a>
                            </li>
                        `).join('')}
                    `);

                    // Load all movies by default
                    currentLibraryId = null;
                } else {
                    // Hide tabs if no libraries
                    tabsContainer.hide();
                }

                // Load movies for current library
                await loadMovies();
            } catch (error) {
                console.error('Failed to load libraries:', error);
                // Fallback to loading all movies
                await loadMovies();
            }
        }

        async function switchLibrary(libraryId) {
            currentLibraryId = libraryId;

            // Update active tab
            $('#libraryTabs .nav-link').removeClass('active');
            event.target.classList.add('active');

            // Load movies for selected library
            await loadMovies();
        }

        async function loadMovies() {
            try {
                const url = currentLibraryId
                    ? `/api/movies?limit=200&libraryId=${currentLibraryId}`
                    : '/api/movies?limit=200';

                const response = await fetch(url);
                const data = await response.json();

                const container = $('#moviesContainer');

                if (data.length === 0) {
                    container.html(`
                        <div class="empty-state">
                            <div class="emoji">üé¨</div>
                            <div>No movies found</div>
                        </div>
                    `);
                    return;
                }

                container.html(`
                    <div class="movies-carousel">
                        ${data.map(movie => `
                            <div class="movie-card" onclick="showMovieDetails('${movie.id}')">
                                <div class="movie-poster">
                                    <img src="/api/image/${movie.id}" alt="${movie.name}"
                                         onerror="this.parentElement.innerHTML='üé¨'">
                                </div>
                                <div class="movie-info">
                                    <div class="movie-title" title="${movie.name}">${movie.name}</div>
                                    <div class="movie-year">${movie.year || 'N/A'}</div>
                                    ${movie.community_rating ? `<div class="movie-year">‚≠ê ${movie.community_rating.toFixed(1)}</div>` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `);
            } catch (error) {
                $('#moviesContainer').html(`
                    <div class="alert alert-danger">Failed to load movies</div>
                `);
            }
        }

        async function showMovieDetails(itemId) {
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('movieDetailsModal'));
            modal.show();

            // Reset content
            $('#movieDetailsContent').html(`
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `);

            try {
                const response = await fetch(`/api/item/${itemId}`);
                const movie = await response.json();

                if (movie.error) {
                    $('#movieDetailsContent').html(`
                        <div class="alert alert-danger">${movie.error}</div>
                    `);
                    return;
                }

                // Update modal title
                $('#movieDetailsModalLabel').text(movie.name);

                // Format runtime
                let runtimeText = 'N/A';
                if (movie.runtime_minutes > 0) {
                    const hours = Math.floor(movie.runtime_minutes / 60);
                    const mins = movie.runtime_minutes % 60;
                    runtimeText = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
                }

                // Build cast HTML
                let castHtml = '';
                if (movie.people && movie.people.length > 0) {
                    const actors = movie.people.filter(p => p.Type === 'Actor').slice(0, 10);
                    if (actors.length > 0) {
                        castHtml = `
                            <h6 class="mt-4 mb-3">Cast</h6>
                            <div class="cast-carousel">
                                ${actors.map(actor => `
                                    <div class="cast-member">
                                        <img src="/api/person-image/${actor.Id}" alt="${actor.Name}"
                                             onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22100%22 height=%22100%22><text y=%2250%%22 x=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2240%22>üë§</text></svg>'">
                                        <div class="cast-name">${actor.Name}</div>
                                        <div class="cast-role">${actor.Role || 'Actor'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                }

                $('#movieDetailsContent').html(`
                    <div class="row">
                        <div class="col-md-4">
                            <img src="/api/image/${movie.id}" alt="${movie.name}"
                                 class="img-fluid rounded"
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22450%22><rect width=%22300%22 height=%22450%22 fill=%22%23e5e7eb%22/><text y=%2250%%22 x=%2250%%22 text-anchor=%22middle%22 dy=%22.3em%22 font-size=%2280%22>üé¨</text></svg>'">
                        </div>
                        <div class="col-md-8">
                            <h4>${movie.name} ${movie.year ? `<small class="text-muted">(${movie.year})</small>` : ''}</h4>

                            <div class="mb-3">
                                ${movie.genres && movie.genres.length > 0 ?
                                    movie.genres.map(g => `<span class="badge bg-secondary me-1">${g}</span>`).join('') : ''}
                                ${movie.official_rating ? `<span class="badge bg-info">${movie.official_rating}</span>` : ''}
                            </div>

                            <div class="row mb-3">
                                <div class="col-sm-6">
                                    <strong>Runtime:</strong> ${runtimeText}
                                </div>
                                ${movie.community_rating ? `
                                <div class="col-sm-6">
                                    <strong>Rating:</strong> ‚≠ê ${movie.community_rating.toFixed(1)}/10
                                </div>` : ''}
                            </div>

                            ${movie.overview ? `
                            <div class="mb-3">
                                <h6>Overview</h6>
                                <p>${movie.overview}</p>
                            </div>` : ''}

                            <div class="mb-3">
                                <h6>File Information</h6>
                                <table class="table table-sm table-borderless">
                                    <tr><td class="text-muted" style="width: 150px;">Path:</td><td><small>${movie.path}</small></td></tr>
                                    <tr><td class="text-muted">Container:</td><td>${movie.container}</td></tr>
                                    <tr><td class="text-muted">Video Codec:</td><td>${movie.video_codec}</td></tr>
                                    <tr><td class="text-muted">Resolution:</td><td>${movie.video_resolution}</td></tr>
                                    <tr><td class="text-muted">Audio Streams:</td><td>${movie.audio_streams}</td></tr>
                                    ${movie.date_created ? `<tr><td class="text-muted">Added:</td><td>${movie.date_created}</td></tr>` : ''}
                                </table>
                            </div>

                            ${castHtml}
                        </div>
                    </div>
                `);

                // Setup Emby link button
                const embyUrl = window.location.protocol + '//' + window.location.hostname + ':8096';
                $('#embyLinkBtn').show().off('click').on('click', function() {
                    window.open(`${embyUrl}/web/index.html#!/item?id=${movie.id}&serverId=${movie.id}`, '_blank');
                });

            } catch (error) {
                $('#movieDetailsContent').html(`
                    <div class="alert alert-danger">Failed to load movie details</div>
                `);
            }
        }

        // Initial load using jQuery
        $(document).ready(function() {
            loadServerStatus();
            loadCurrentProcessing();
            loadCompletedTasks();
            loadIndexedMedia();
            loadMoviesWithLibraries();

            // Auto-refresh
            setInterval(loadCurrentProcessing, 5000); // Refresh processing every 5 seconds
            setInterval(loadServerStatus, 30000); // Refresh status every 30 seconds
        });
    </script>
</body>
</html>
